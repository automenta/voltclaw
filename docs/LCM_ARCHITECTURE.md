# LCM Architecture Diagram

## VoltClaw RLM-LCM Hybrid Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VoltClaw Agent                                  â”‚
â”‚                    (RLM + LCM Hybrid System)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚                           â”‚
        â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RLM Paradigm   â”‚    â”‚   Core Agent     â”‚    â”‚   LCM Paradigm   â”‚
â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚
â”‚ â€¢ Record-Label   â”‚    â”‚ â€¢ Session Mgmt   â”‚    â”‚ â€¢ Context Refs   â”‚
â”‚ â€¢ Symbolic Rec   â”‚    â”‚ â€¢ Tool Registry  â”‚    â”‚ â€¢ Hierarchical   â”‚
â”‚ â€¢ sharedData     â”‚    â”‚ â€¢ LLM Provider   â”‚    â”‚ â€¢ Compression    â”‚
â”‚ â€¢ rlm_* tools    â”‚    â”‚ â€¢ Memory Mgr     â”‚    â”‚ â€¢ context_*      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚                           â”‚
        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
        â”‚         â”‚                                   â”‚         â”‚
        â–¼         â–¼                                   â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Memory Layer                                 â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Session     â”‚  â”‚  Long-term   â”‚  â”‚  Context     â”‚              â”‚
â”‚  â”‚  Storage     â”‚  â”‚  Memory      â”‚  â”‚  References  â”‚              â”‚
â”‚  â”‚  (SQLite)    â”‚  â”‚  (SQLite)    â”‚  â”‚  (Memory)    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                      â”‚
â”‚  â€¢ Encrypted storage           â€¢ Semantic search                    â”‚
â”‚  â€¢ Session hierarchy           â€¢ Knowledge graph                    â”‚
â”‚  â€¢ Shared data                 â€¢ Context compression                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Tools Layer                                  â”‚
â”‚                                                                      â”‚
â”‚  RLM Tools:                LCM Tools:              Other Tools:      â”‚
â”‚  â€¢ rlm_call               â€¢ context_create         â€¢ read_file      â”‚
â”‚  â€¢ rlm_call_parallel      â€¢ context_resolve        â€¢ write_file     â”‚
â”‚  â€¢ rlm_map                â€¢ context_delete         â€¢ http_get       â”‚
â”‚  â€¢ rlm_filter             â€¢ context_stats          â€¢ execute        â”‚
â”‚  â€¢ rlm_reduce                                      â€¢ call           â”‚
â”‚  â€¢ rlm_shared_*                                    â€¢ memory_*       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Context Flow in Recursive Operations

### Before LCM (RLM Only)
```
Parent Agent
â”‚
â”œâ”€ Context: [5000 tokens of data]
â”‚
â”œâ”€â–º Child 1: "Analyze file1" [Copies 5000 tokens] âŒ Inefficient
â”‚
â”œâ”€â–º Child 2: "Analyze file2" [Copies 5000 tokens] âŒ Inefficient
â”‚
â””â”€â–º Child 3: "Analyze file3" [Copies 5000 tokens] âŒ Inefficient

Total: 15,000 tokens for context passing
```

### After LCM (RLM + LCM Hybrid)
```
Parent Agent
â”‚
â”œâ”€ Context: [5000 tokens in shared memory]
â”‚  â””â”€ Reference: ctx_123_abc [50 tokens]
â”‚
â”œâ”€â–º Child 1: "Analyze file1" [Passes ref: 50 tokens] âœ… Efficient
â”‚   â””â”€ Resolves ctx_123_abc â†’ Full context
â”‚
â”œâ”€â–º Child 2: "Analyze file2" [Passes ref: 50 tokens] âœ… Efficient
â”‚   â””â”€ Resolves ctx_123_abc â†’ Full context
â”‚
â””â”€â–º Child 3: "Analyze file3" [Passes ref: 50 tokens] âœ… Efficient
    â””â”€ Resolves ctx_123_abc â†’ Full context

Total: 150 tokens for context passing (99% reduction!)
```

## Hierarchical Context Inheritance

```
Level 0 (Root)
â”œâ”€ project: "VoltClaw"
â”œâ”€ version: "2.0.0"
â””â”€ goal: "LCM integration"
    â”‚
    â””â”€â–º Level 1 (Child)
        â”œâ”€ [inherits] project: "VoltClaw"
        â”œâ”€ [inherits] version: "2.0.0"
        â”œâ”€ [inherits] goal: "LCM integration"
        â”œâ”€ subtask: "Implement context manager"
        â””â”€ files: ["lcm-context.ts", ...]
            â”‚
            â””â”€â–º Level 2 (Grandchild)
                â”œâ”€ [inherits] project: "VoltClaw"
                â”œâ”€ [inherits] version: "2.0.0"
                â”œâ”€ [inherits] goal: "LCM integration"
                â”œâ”€ [inherits] subtask: "Implement context manager"
                â”œâ”€ [inherits] files: ["lcm-context.ts", ...]
                â”œâ”€ implementation: "ContextReferenceManager"
                â””â”€ status: "complete"
```

## Context Reference Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create      â”‚
â”‚  Reference   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Store in    â”‚
â”‚  Memory      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pass Ref    â”‚â—„â”€â”€â”€â”€â”€â”€ Multiple agents can use same ref
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Resolve     â”‚â—„â”€â”€â”€â”€â”€â”€ Lazy loading on demand
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Use Data    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Expire/     â”‚
â”‚  Cleanup     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## RLM-LCM Tool Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Tool Call Flow                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Request: "Analyze this codebase"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Create Context Reference                                  â”‚
â”‚     refId = context_create(['files', 'requirements'])         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Use rlm_map for Parallel Processing                       â”‚
â”‚     results = rlm_map(files, f => ({                          â”‚
â”‚       task: `Analyze ${f}`,                                   â”‚
â”‚       contextRef: refId  // â† LCM integration                 â”‚
â”‚     }))                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Each Parallel Call Resolves Context                       â”‚
â”‚     - Child agent receives contextRef                         â”‚
â”‚     - Resolves reference to get full context                  â”‚
â”‚     - Processes task with complete information                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Aggregate Results                                         â”‚
â”‚     - All results collected                                   â”‚
â”‚     - Context reference cleaned up                            â”‚
â”‚     - Final response synthesized                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Memory Efficiency Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Token Usage Comparison                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Scenario: 10 sub-agents, each needs 5KB context

RLM Only (Copy):
â”œâ”€ Parent: 5KB
â”œâ”€ Child 1: 5KB (copy)
â”œâ”€ Child 2: 5KB (copy)
â”œâ”€ ...
â””â”€ Child 10: 5KB (copy)
   Total: 55KB (~55,000 tokens)

RLM + LCM (Reference):
â”œâ”€ Parent: 5KB (stored once)
â”œâ”€ Child 1: 50B (reference)
â”œâ”€ Child 2: 50B (reference)
â”œâ”€ ...
â””â”€ Child 10: 50B (reference)
   Total: 5.5KB (~5,500 tokens)

Savings: 90% reduction! ğŸ‰
```

## Component Interactions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Component Interaction                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VoltClawAgent
    â”‚
    â”œâ”€â–º ContextReferenceManager
    â”‚     â”œâ”€â–º createReference() â†’ stores in Memory
    â”‚     â”œâ”€â–º resolveReference() â† retrieves from Memory
    â”‚     â””â”€â–º cleanup() â†’ removes expired refs
    â”‚
    â”œâ”€â–º HierarchicalContext
    â”‚     â”œâ”€â–º createChild() â†’ inheritance chain
    â”‚     â”œâ”€â–º set()/get() â†’ local + inherited data
    â”‚     â””â”€â–º visualize() â†’ debug hierarchy
    â”‚
    â”œâ”€â–º LCM Tools
    â”‚     â”œâ”€â–º context_create â†’ uses ContextReferenceManager
    â”‚     â”œâ”€â–º context_resolve â†’ uses ContextReferenceManager
    â”‚     â”œâ”€â–º context_delete â†’ uses ContextReferenceManager
    â”‚     â””â”€â–º context_stats â†’ uses ContextReferenceManager
    â”‚
    â””â”€â–º RLM Tools (Enhanced)
          â”œâ”€â–º rlm_call â†’ supports contextRef
          â”œâ”€â–º rlm_map â†’ auto-shares context via refs
          â”œâ”€â–º rlm_filter â†’ auto-shares context via refs
          â””â”€â–º rlm_reduce â†’ shared accumulator pattern
```

---

**Legend:**
- â†’ : Data flow
- â–º : Component interaction
- â””â”€â–º : Child/inheritance relationship
- â† : Data retrieval
